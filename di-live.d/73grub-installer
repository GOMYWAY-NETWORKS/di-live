#!/usr/bin/python

import os
import sys
import debconf

from common import prepend_path, system, log

class Error(Exception):
    pass

class TargetMounts:
    def __init__(self, target='/target'):
        self.targetdev = os.path.join(target, 'dev')
        self.targetproc = os.path.join(target, 'proc')

        self.mount()

    def mount(self):
        if not is_mounted(self.targetdev):
            _system("mount -o bind /dev %s" % self.targetdev)

        if not is_mounted(self.targetproc):
            _system("mount -o bind /proc %s" % self.targetproc)

    def umount(self):
        _system("umount -f %s" % self.targetdev)
        _system("umount -f %s" % self.targetproc)

    def __del__(self):
        self.umount()

def _system(command):
    error = os.system(command)
    if error:
        exitcode = os.WEXITSTATUS(error)
        log("non-zero exitcode (%d) for command: %s" % (exitcode, command))
        raise Error(command, exitcode)

def is_mounted(dir):
    mounts = file("/proc/mounts").read()
    if mounts.find(dir) != -1:
        return True
    return False

def main():
    if not os.path.exists('/target') or not is_mounted('/target'):
        debconf.runFrontEnd()
        db = debconf.Debconf()

        db.capb('backup')
        db.input(debconf.CRITICAL, 'base-installer/no_target_mounted')
        db.go()
        sys.exit(10) #return to menu

    #mount bind /dev and /proc on target otherwise grub-installer will fail
    targetmounts = TargetMounts('/target')

    prepend_path('/usr/lib/di-live/compat')
    system('/usr/share/grub-installer/grub-installer /target')


if __name__ == "__main__":
    main()

