#!/usr/bin/python

import os
from os.path import *

import debconf

class Error(Exception):
    pass

class Debian_Priority:
    """class for controlling DEBIAN_PRIORITY"""

    def __init__(self):
        self.original = os.environ.get('DEBIAN_PRIORITY')
        self.current = self.original

    def __del__(self):
        self.revert()

    def get(self):
        return self.current

    def set(self, priority):
        if priority in (None, self.current):
            return

        priorities = ('low', 'medium', 'high', 'critical')
        if priority not in priorities:
            raise Error('illegal debian priority', priority)

        os.environ['DEBIAN_PRIORITY'] = priority
        self.current = priority

    def revert(self):
        """revert priority back to original priority"""
        self.set(self.original)

    def decrease(self):
        """decrease priority to medium (or low if original was low)"""
        if self.original == 'low':
            self.set('low')
        else:
            self.set('medium')

class Menu:
    """class for controlling a debconf menu with choices"""

    def __init__(self, template, title=None, priority='high', subst='CHOICES'):
        debconf.runFrontEnd()
        self.template = template
        self.db = debconf.Debconf(title)
        self.priority = priority
        self.subst = subst

    def __del__(self):
        self.db.stop()

    def display(self, choices):
        self.db.reset(self.template)
        self.db.subst(self.template, self.subst, choices)
        self.db.input(self.priority, self.template)
        try:
            self.db.go()
        except debconf.DebconfError, e:
            if not e[0] == 30 and not e[1] == "backup":
                raise Error('debconf error', e)

    def get_choice(self):
        return self.db.get(self.template)

class Component:
    """class for managing a component"""

    def __init__(self, path):
        self.path = path
        self.name = basename(path)
        self.title = self.name # until components have titles
        self.exitcode = None

    def execute(self):
        error = os.system(self.path)
        if error:
            self.exitcode = os.WEXITSTATUS(error)
            return False

        self.exitcode = 0
        return True

class Components(dict):
    """class for holding components"""

    def __init__(self, dirpath):
        if not exists(dirpath):
            raise Error('non existent components path', dirpath)

        for file in os.listdir(dirpath):
            try:
                self.add(join(dirpath, file))
            except:
                pass

    def __iter__(self):
        """return component in alpha-numeric ordering according to name"""
        keys = self.keys()
        keys.sort()
        for key in keys:
            yield self[key]

    @staticmethod
    def _is_executable(path):
        if os.stat(path).st_mode & 0111 == 0:
            return False
        return True

    def add(self, path):
        if not self._is_executable(path):
            raise Error('component not executable', path)

        name = basename(path)
        self[name] = Component(path)
    
    def remove(self, name):
        del self[name]

class Components_Menu:
    """class to mimic d-i main-menu"""

    def __init__(self, component_dir, menu_template, menu_title=None):
        self.components = Components(component_dir)
        self.menu = Menu(menu_template, menu_title)

        self.priority = Debian_Priority()

    def _get_next_component(self):
        if self.priority.get() in ('low', 'medium'):
            self.menu.display(", ".join([ c.title for c in self.components ]))
            title = self.menu.get_choice()

            for c in self.components:
                if c.title == title:
                    return c
        else:
            for c in self.components:
                if c.name > self.last:
                    return c

        return None

    def run(self):
        self.last = ''
        while 1:
            component = self._get_next_component()
            if component is None:
                break

            component.execute()
            if component.exitcode == 0:
                self.last = component.name
                self.priority.revert()
            else:
                self.priority.decrease()

def main():
    components_dir = '/usr/lib/di-live.d'
    menu_template = 'di-live/main_menu'
    menu_title = 'Debian Installer Live'

    Components_Menu(components_dir, menu_template, menu_title).run()


if __name__ == "__main__":
    main()

